<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Carta para Marbella — Fumando en mi Funeral (estética)</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400;1,700&family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg-overlay: rgba(6,6,12,0.6);
      --accent: #b86b6b;
      --muted: #cfc7c7;
      --glass: rgba(255,255,255,0.04);
      --font-serif: 'Playfair Display', serif;
      --font-sans: 'Montserrat', sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:var(--font-sans);background:#000;color:#eee}

    /* Background image: reemplaza la URL por la carátula/imagen de 'Fumando en mi Funeral' */
    body::before{
      content:'';position:fixed;inset:0;background-image:url('background.jpg');background-size:cover;background-position:center;filter:grayscale(40%) contrast(85%);z-index:-2;}
    body::after{content:'';position:fixed;inset:0;background:linear-gradient(180deg, rgba(2,2,6,0.45), rgba(7,7,10,0.78));z-index:-1}

    .app{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:32px}
    .card{width:100%;max-width:980px;background:linear-gradient(135deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:16px;box-shadow:0 10px 30px rgba(3,3,6,0.6);overflow:hidden;border:1px solid rgba(255,255,255,0.03)}

    header{padding:28px 36px;background:linear-gradient(90deg, rgba(0,0,0,0.25), rgba(0,0,0,0.12));display:flex;align-items:center;gap:16px}
    header h1{font-family:var(--font-serif);font-size:20px;margin:0;letter-spacing:1px}
    header p{margin:0;font-size:13px;color:var(--muted)}

    .screens{display:grid;grid-template-columns:1fr;min-height:560px}
    .screen{padding:36px;display:none;gap:12px}
    .screen.active{display:block}

    /* Pantalla 1 - verificación */
    .verify{display:flex;flex-direction:column;gap:18px;align-items:center;justify-content:center;text-align:center}
    .verify h2{font-family:var(--font-serif);font-size:28px;margin:0;color:#fff}
    .verify p{color:var(--muted);max-width:700px}
    .input-row{display:flex;gap:10px;align-items:center}
    input[type=text]{padding:12px 14px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit;min-width:320px;font-size:16px}
    button.btn{padding:12px 16px;border-radius:10px;border:0;background:linear-gradient(90deg,var(--accent), #8b4f4f);color:#111;cursor:pointer;font-weight:600}
    button.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    .hint{font-size:13px;color:var(--muted)}

    /* Pantalla 2 - collage */
    .collage-controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .collage-grid{margin-top:18px;display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px}
    .thumb{position:relative;border-radius:8px;overflow:hidden;background:var(--glass);min-height:100px;display:flex;align-items:center;justify-content:center}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .thumb .remove{position:absolute;top:6px;right:6px;background:rgba(0,0,0,0.45);border-radius:6px;padding:4px 6px;font-size:12px;cursor:pointer}

    /* Pantalla 3 - carta */
    .letter{max-width:880px;margin:0 auto;padding:30px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03)}
    .letter h2{font-family:var(--font-serif);font-size:28px;margin:0 0 6px}
    .letter p{line-height:1.55;color:#e9e1e1;font-size:16px}
    footer{padding:18px 36px;background:linear-gradient(90deg, rgba(0,0,0,0.08), rgba(0,0,0,0.02));display:flex;justify-content:space-between;align-items:center}

    /* audio control */
    .audio-controls{display:flex;gap:8px;align-items:center}
    .badge{font-size:12px;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.02)}

    /* responsive */
    @media (max-width:720px){.card{border-radius:12px}.verify h2{font-size:22px}.letter{padding:18px}}
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <header>
        <div style="width:48px;height:48px;border-radius:8px;background:rgba(0,0,0,0.25);display:flex;align-items:center;justify-content:center;font-weight:700">☠</div>
        <div>
          <h1>Fumando en mi Funeral — Carta a Marbella</h1>
          <p>Estética melancólica / sonido ambiental generado</p>
        </div>
        <div style="margin-left:auto" class="audio-controls">
          <span class="badge" id="audioState">Silencio</span>
          <button class="btn ghost" id="toggleAudio">Reproducir ambiente</button>
        </div>
      </header>

      <div class="screens">
        <!-- Pantalla 1 -->
        <section id="screen-1" class="screen active">
          <div class="verify">
            <h2>Verificación de identidad</h2>
            <p>Por favor, confirma tu nombre exactamente como está escrito para continuar. Esto protege este mensaje íntimo.</p>
            <div class="input-row">
              <input type="text" id="nameInput" placeholder="Escribe el nombre completo..." value="MARBELLA MARTINEZ LUIS" autocomplete="off">
              <button class="btn" id="verifyBtn">Verificar</button>
              <button class="btn ghost" id="clearBtn">Borrar</button>
            </div>
            <p class="hint">Introduce el nombre en mayúsculas tal como se muestra: <strong>MARBELLA MARTINEZ LUIS</strong></p>
            <p id="err" style="color:#ff9b9b;font-weight:600;display:none">Nombre incorrecto. Intenta de nuevo.</p>
          </div>
        </section>

        <!-- Pantalla 2 -->
        <section id="screen-2" class="screen">
          <div>
            <h2 style="font-family:var(--font-serif)">Collage de recuerdos</h2>
            <p class="hint">Sube fotos que quieras ver en el collage. Puedes arrastrar varios archivos o usar el selector.</p>
            <div class="collage-controls">
              <input type="file" id="files" accept="image/*" multiple>
              <button class="btn" id="toLetter">Siguiente: Carta</button>
              <button class="btn ghost" id="resetCollage">Limpiar collage</button>
            </div>
            <div class="collage-grid" id="grid"></div>
          </div>
        </section>

        <!-- Pantalla 3 -->
        <section id="screen-3" class="screen">
          <div class="letter">
            <h2>Carta para mi amor, Marbella Martínez Luis</h2>
            <p>Hola, mi amor...<br>
            Para cuando leas esto, quizá ya no esté, o tal vez sí, pero ya no del mismo modo.<br>
            <strong>Perdóname, por favor.</strong><br>
            Si sigo aquí, no te preocupes por mi salud —vive, sal, ríe, conoce gente—, que la vida es corta y mereces cada pedacito de luz que el mundo pueda darte.<br><br>
            Solo quiero que recuerdes que te amo...<br>
            Te amo de una forma que las palabras no alcanzan a explicar.<br>
            Sé que no fui el mejor hombre, y tal vez no supe cuidar bien lo que tenía, pero déjame compensarlo con este mensaje, escrito con los últimos pedazos de corazón que aún laten por ti.<br><br>
            Gracias, amor mío, por darme lo que nadie me dio de niño: cariño, ternura, y ese abrazo que cura.<br>
            Déjame ahora liberarte del peso que nunca pediste cargar. No llores por mí, que en cada pensamiento tuyo seguiré respirando un poco más.<br><br>
            Con todo mi amor,<br>
            <strong>Juan, tu amolchito...</strong><br>
            o al menos eso espero.<br><br>
            <em>P.D.: Gracias por enseñarme lo que es amar de verdad. Te llevaré en el corazón, y te cuidaré, aunque sea desde lo más lejos...</em></p>
          </div>
        </section>
      </div>

      <footer>
        <div style="display:flex;gap:10px;align-items:center">
          <button class="btn ghost" id="backBtn">Atrás</button>
          <span class="hint">Diseño sensible — reemplaza 'background.jpg' por la carátula real.</span>
        </div>
        <div>
          <button class="btn" id="downloadLetter">Descargar carta (.txt)</button>
        </div>
      </footer>
    </div>
  </div>

  <script>
    // Simple screen manager
    const screens = {1:document.getElementById('screen-1'),2:document.getElementById('screen-2'),3:document.getElementById('screen-3')}
    let current=1
    function show(n){
      Object.values(screens).forEach(s=>s.classList.remove('active'))
      screens[n].classList.add('active')
      current=n
    }

    // Verification logic
    const verifyBtn = document.getElementById('verifyBtn')
    const nameInput = document.getElementById('nameInput')
    const err = document.getElementById('err')
    verifyBtn.addEventListener('click', ()=>{
      const val = (nameInput.value||'').trim()
      if(val === 'MARBELLA MARTINEZ LUIS'){
        err.style.display='none'
        show(2)
      } else {
        err.style.display='block'
      }
    })
    document.getElementById('clearBtn').addEventListener('click', ()=>{nameInput.value=''; nameInput.focus(); err.style.display='none'})

    // Collage handling
    const filesEl = document.getElementById('files')
    const grid = document.getElementById('grid')
    const resetCollage = document.getElementById('resetCollage')
    const toLetter = document.getElementById('toLetter')

    let images = []
    filesEl.addEventListener('change', (e)=>{
      const chosen = Array.from(e.target.files)
      chosen.forEach(file=>{
        if(!file.type.startsWith('image/')) return
        const reader = new FileReader()
        reader.onload = (ev)=>{
          images.push({name:file.name,src:ev.target.result})
          renderGrid()
        }
        reader.readAsDataURL(file)
      })
      filesEl.value=''
    })

    function renderGrid(){
      grid.innerHTML=''
      images.forEach((img, i)=>{
        const div = document.createElement('div')
        div.className='thumb'
        div.innerHTML = `<img src="${img.src}" alt="img-${i}"><div class="remove">✕</div>`
        div.querySelector('.remove').addEventListener('click', ()=>{images.splice(i,1);renderGrid()})
        grid.appendChild(div)
      })
    }
    resetCollage.addEventListener('click', ()=>{images=[];renderGrid()})
    toLetter.addEventListener('click', ()=>show(3))

    // Back button
    document.getElementById('backBtn').addEventListener('click', ()=>{
      if(current>1) show(current-1)
    })

    // Download letter as txt
    document.getElementById('downloadLetter').addEventListener('click', ()=>{
      const text = document.querySelector('.letter').innerText
      const blob = new Blob([text],{type:'text/plain;charset=utf-8'})
      const url = URL.createObjectURL(blob)
      const a = document.createElement('a')
      a.href = url; a.download = 'carta_marabella.txt'
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url)
    })

    // Ambient sound using WebAudio (sintético, no requiere archivos externos)
    let audioCtx, masterGain, isPlaying=false, noiseNode, oscA, oscB
    const toggleAudio = document.getElementById('toggleAudio')
    const audioState = document.getElementById('audioState')

    function startAmbient(){
      audioCtx = new (window.AudioContext||window.webkitAudioContext)()
      masterGain = audioCtx.createGain(); masterGain.gain.value = 0.0; masterGain.connect(audioCtx.destination)

      // Two slow detuned oscillators for a pad
      oscA = audioCtx.createOscillator(); oscA.type='sine'; oscA.frequency.value = 110
      oscB = audioCtx.createOscillator(); oscB.type='sine'; oscB.frequency.value = 114
      const fader = audioCtx.createGain(); fader.gain.value = 0.15
      oscA.connect(fader); oscB.connect(fader); fader.connect(masterGain)

      // gentle noise for texture
      const bufferSize = 2*audioCtx.sampleRate
      const noiseBuffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate)
      const output = noiseBuffer.getChannelData(0)
      for(let i=0;i<bufferSize;i++){ output[i] = (Math.random()*2-1)*0.003 }
      noiseNode = audioCtx.createBufferSource(); noiseNode.buffer = noiseBuffer; noiseNode.loop=true
      const noiseGain = audioCtx.createGain(); noiseGain.gain.value = 0.02
      noiseNode.connect(noiseGain); noiseGain.connect(masterGain)

      // gentle LFO to modulate master gain
      const lfo = audioCtx.createOscillator(); lfo.type='sine'; lfo.frequency.value = 0.07
      const lfoGain = audioCtx.createGain(); lfoGain.gain.value = 0.03
      lfo.connect(lfoGain); lfoGain.connect(masterGain.gain)

      oscA.start(); oscB.start(); noiseNode.start(); lfo.start();

      // ramp up
      masterGain.gain.linearRampToValueAtTime(0.16, audioCtx.currentTime + 2.5)
      isPlaying=true; audioState.textContent='Ambiente: ON'; toggleAudio.textContent='Pausar ambiente'
    }
    function stopAmbient(){
      if(!audioCtx) return
      masterGain.gain.cancelScheduledValues(audioCtx.currentTime)
      masterGain.gain.linearRampToValueAtTime(0.0, audioCtx.currentTime + 1.5)
      setTimeout(()=>{
        try{oscA.stop(); oscB.stop(); noiseNode.stop(); audioCtx.close()}catch(e){}
        audioCtx=null; isPlaying=false; audioState.textContent='Silencio'; toggleAudio.textContent='Reproducir ambiente'
      },1700)
    }
    toggleAudio.addEventListener('click', ()=>{
      if(!isPlaying) startAmbient(); else stopAmbient()
    })

    // keyboard: Enter to verify quickly
    nameInput.addEventListener('keyup',(e)=>{ if(e.key==='Enter') verifyBtn.click() })

    // Accessibility: focus first input
    nameInput.focus()
  </script>
</body>
</html>
